// Generated by CoffeeScript 1.8.0
(function() {
  var Keen, Tracker, geoip, getenv;

  Keen = require('keen-js');

  geoip = require('geoip-lite');

  getenv = require('getenv');

  Tracker = (function() {
    function Tracker() {
      this.KEEN_TRACK = getenv.bool('KEEN_TRACK', false);
      this.KEEN_PROJECTID = getenv('KEEN_PROJECT_ID', '');
      this.KEEN_WRITEKEY = getenv('KEEN_WRITE_KEY', '');
      this.client = new Keen({
        projectId: this.KEEN_PROJECTID,
        writeKey: this.KEEN_WRITEKEY
      });
    }

    Tracker.prototype.ready = function() {
      return this.KEEN_TRACK && this.KEEN_PROJECTID !== '' && this.KEEN_WRITEKEY !== '';
    };

    Tracker.prototype.connectionClosed = function(client, remoteAddress) {
      var connection, geo;
      if (!this.ready()) {
        return;
      }
      geo = geoip.lookup(remoteAddress) || {};
      console.log('remoteAddress', remoteAddress, geo);
      connection = {
        sessionId: client.sessionId,
        geo: {
          country: geo.country,
          region: geo.region,
          city: geo.city
        },
        duration: (new Date() - client.sessionStarted) / 60000
      };
      return this.client.addEvent("connections", connection, function(err, res) {
        if (err) {
          return console.log('Connection could not be saved.');
        } else {
          return console.log('Connection logged.', connection, res);
        }
      });
    };

    return Tracker;

  })();

  module.exports = Tracker;

}).call(this);
